<!-- ======================================================== -->
<!-- = index.html - Main landing page for RowErg Diary      -->
<!-- ======================================================== -->
<!DOCTYPE HTML>
<html>
	<head>
		<title>RowErg Diary</title> <!-- Page Title -->
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}"> <!-- Favicon Link -->
		<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" /> <!-- Main Stylesheet -->
		<link rel="stylesheet" href="{{ url_for('static', filename='css/mystyles.css') }}" /> <!-- Custom Stylesheet -->
	</head>
	<body class="is-preload">

		<!-- == Main Content Area ============================================ -->
		<div id="content" class="custom-calendar">
			<div class="inner">
				<!-- -- Flash Messages Section ------------------- -->
				{% with messages = get_flashed_messages(with_categories=true) %}
					{% if messages %}
						<article class="box post post-excerpt">
						{% for category, message in messages %}
							<div class="box alert-{{ category }}" style="font-size: 1.3em; border: 1px solid; padding: 16px; margin-bottom: 20px; text-align: center;">
								{{ message }} <!-- Display flash message -->
							</div>
						{% endfor %}
						</article>
					{% endif %}
				{% endwith %}

				<!-- -- Input Forms Section (Widgets) ------------------- -->
				<article class="box post post-excerpt">
					<div class="flex-container">
						<!-- --- Manual Workout Input Form ------------------- -->
						<div class="flex-box">
							<h3>Manual Workout Input</h3>
							<form id="workoutInputForm" method="POST" action="{{ url_for('submit_manual_workout') }}">
								<!-- ---- Workout Name and Date ------------------- -->
								<div class="form-row-split">
									<div class="form-field-group">
										<label for="workoutName">Name:</label>
										<input type="text" id="workoutName" name="workoutName" placeholder="e.g., Morning Row">
									</div>
									<div class="form-field-group">
										<label for="workoutDate">Date:</label>
										<input type="date" id="workoutDate" name="workoutDate" required>
									</div>
								</div>
								
								<!-- ---- Workout Time and Distance ------------------- -->
								<div class="form-row-split">
									<div class="form-field-group">
										<label for="workoutTime">Time (HH:MM:SS.ms):</label>
										<input type="text" id="workoutTime" name="workoutTime" placeholder="1:46:45.2 or 65:45.2" required pattern="^([0-9]+:)?([0-9]+:){1}([0-5]?[0-9])(\.[0-9]+)?$">
									</div>
									<div class="form-field-group">
										<label for="workoutDistance">Distance (Meters):</label>
										<input type="number" id="workoutDistance" name="workoutDistance" placeholder="e.g., 2000" required>
									</div>
								</div>

								<!-- ---- Workout Level and Calculated Pace ------------------- -->
								<div class="form-row-split">
									<div class="form-field-group">
										<label for="workoutLevel">Level:</label>
										<input type="text" id="workoutLevel" name="workoutLevel" placeholder="1-10">
									</div>
									<div class="form-field-group">
										<label for="calculatedPace">Pace:</label>
										<input type="text" id="calculatedPace" name="calculatedPace" placeholder="--:--.--" readonly> <!-- Pace is auto-calculated by pace.js -->
									</div>
								</div>

								<!-- ---- Workout Notes ------------------- -->
								<div>
									<label for="workoutNotes">Notes:</label>
									<textarea id="workoutNotes" name="workoutNotes" placeholder="e.g., Feeling strong today!"></textarea>
								</div>
								
								<!-- ---- Submit Button ------------------- -->
								<button type="submit" id="workoutSubmitBtn" class="button">Add Workout</button>
							</form>
						</div>
						<!-- --- JSON Import Form ------------------- -->
						<div class="flex-box">
							<h3>Mywelness Json Import</h3>
							<form id="jsonInputForm" method="POST" action="{{ url_for('submit_json_workout') }}">
								<div>
									<label for="jsonData">Json:</label>
									<textarea id="jsonData" class="text_data" name="jsonData" placeholder='{"key": "value"}' required></textarea>
								</div>
								<div>
									<label for="jsonNotes">Notes:</label>
									<textarea id="jsonNotes" name="jsonNotes" placeholder="Any specific notes for this imported workout?"></textarea>
								</div>
								<div>
									<button type="submit" id="jsonSubmitBtn" class="button">Submit JSON</button>
								</div>
							</form>
						</div>
					</div>
				</article>
						
				<!-- -- Recent Workouts List Section ------------------- -->
				{% if workouts_display_data %} <!-- Check if there are recent workouts to display -->
					{% for item_data in workouts_display_data %} <!-- Loop through each recent workout -->
						<hr class="extra_article"> <!-- Separator line -->
						<article class="box post post-excerpt">
							<header style="margin-bottom: 0px; padding-top: 0px;">
								<h2 style="margin-bottom: 5px;"><a href="{{ url_for('details', workout_id=item_data.workout_obj.workout_id) }}">{{ item_data.name | default('Unnamed Workout') }}</a></h2> <!-- Workout Name (link to details) -->
							</header>
							<div class="info">
								<!-- Workout Date (formatted) -->
								<span class="date"><span class="month">{{ item_data.workout_obj.workout_date.strftime('%b') if item_data.workout_obj.workout_date else 'N/A' }}<span>{{ (item_data.workout_obj.workout_date.strftime('%B'))[3:] if item_data.workout_obj.workout_date else 'N/A' }}</span></span> <span class="day">{{ item_data.workout_obj.workout_date.strftime('%d') if item_data.workout_obj.workout_date else 'N/A' }}</span><span class="year">, {{ item_data.workout_obj.workout_date.strftime('%Y') if item_data.workout_obj.workout_date else 'N/A' }}</span></span>
								<!-- Workout Stats -->
								<ul class="stats">
									<li><a href="#" class="icon distance">{{ '{:,.0f}'.format(item_data.workout_obj.total_distance_meters) if item_data.workout_obj.total_distance_meters is not none else 'N/A' }} m</a></li> <!-- Total Distance -->
									<li><a href="#" class="icon time">{{ item_data.workout_obj.duration_seconds | format_total_seconds_human_readable }}</a></li> <!-- Duration -->
									<li><a href="#" class="icon split">{{ item_data.workout_obj.average_split_seconds_500m | format_split_ms }}</a></li> <!-- Average Split -->
									
									<li><a href="{{ url_for('details', workout_id=item_data.workout_obj.workout_id) }}" class="icon details" style="color:green">Details</a></li> <!-- Link to Details Page -->
									<li><a href="#" class="icon brands fa-facebook-f"></a></li> <!-- Placeholder Social Media Icon -->
								</ul>
							</div>
							<!-- Pace Chart for each workout -->
							{% if item_data.chart_time_categories and item_data.pace_series_data and item_data.pace_series_data != 'null' %}
								<div id="paceChart-{{ item_data.workout_obj.workout_id }}" style="width:100%; min-height:250px; background:#f4f7fb; border:1px solid #e0e0e0; margin: 10px 0;">
									<!-- Chart will be rendered here by JavaScript -->
								</div>
							{% else %}
							<!-- Fallback placeholder if no chart data -->
							<div style="width:100%; height:250px; background:#f4f7fb; border:1px dashed #b3c6e7; display:flex; align-items:center; justify-content:center; margin: 10px 0;">
								<span style="color:#6a8fd7; font-size:1.2em;">[ No pace data available for {{ item_data.name | default('this workout') }} ]</span>
							</div>
							{% endif %}
						</article>
					{% endfor %}
				{% else %} <!-- If no recent workouts are found -->							
					<article class="box post post-excerpt">
						<div class="box alert-info" style="font-size: 1.3em; border: 1px solid; padding: 16px; margin-bottom: 20px; text-align: center;">
							No workouts found. <!-- Message indicating no workouts -->
						</div>
					</article>
					<p></p>
				{% endif %}
					
			</div>
		</div>
		<!-- == Sidebar Inclusion ============================================ -->
		{% include '_sidebar.html' %} <!-- Include the sidebar template -->

		<!-- == Scripts ============================================ -->
		<script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
		<script src="{{ url_for('static', filename='js/browser.min.js') }}"></script>
		<script src="{{ url_for('static', filename='js/breakpoints.min.js') }}"></script>
		<script src="{{ url_for('static', filename='js/util.js') }}"></script>
		<script src="{{ url_for('static', filename='js/main.js') }}"></script>
		<script src="{{ url_for('static', filename='js/pace.js') }}"></script> <!-- Script for pace calculation -->
		<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script> <!-- ApexCharts Library -->
		<script>
			document.addEventListener("DOMContentLoaded", function() {
				// Common X-axis formatter
				function formatXAxisTime(value) {
					if (typeof value !== 'number' || isNaN(value)) {
						return String(value); // Return as string if not a valid number
					}
					const totalSeconds = Math.floor(value); 
					const minutes = Math.floor(totalSeconds / 60);
					const seconds = totalSeconds % 60;
					return `${minutes}:${seconds.toString().padStart(2, '0')}`;
				}

				// Pace specific formatter for tooltip and y-axis
				function formatPaceDisplay(seconds) {
					if (seconds === null || typeof seconds === 'undefined' || seconds <= 0) {
						return null; 
					}
					const totalSecondsFloat = parseFloat(seconds);
					const minutes = Math.floor(totalSecondsFloat / 60);
					const remainingSeconds = totalSecondsFloat % 60;
					const secs = Math.floor(remainingSeconds);
					const tenths = Math.floor((remainingSeconds - secs) * 10);
					return `${minutes}:${secs.toString().padStart(2, '0')}.${tenths}`;
				}

				{% for item_data in workouts_display_data %}
					{# Check if the Python strings are not 'null' and exist #}
					{% if item_data.chart_time_categories and item_data.chart_time_categories != 'null' and item_data.pace_series_data and item_data.pace_series_data != 'null' %}
						try {
							// Directly use the |safe output.
							// Python's json.dumps() creates a string that Jinja's |safe filter outputs
							// as a valid JavaScript array literal (e.g., [1,2,3]) or the JavaScript null literal.
							var chartCategories_{{ item_data.workout_obj.workout_id }} = {{ item_data.chart_time_categories | safe }};
							var chartPaceData_{{ item_data.workout_obj.workout_id }} = {{ item_data.pace_series_data | safe }};

							// The variables are now actual JavaScript arrays or null.
							// ApexCharts expects arrays for categories and data.
							if (chartCategories_{{ item_data.workout_obj.workout_id }} !== null && chartPaceData_{{ item_data.workout_obj.workout_id }} !== null) {
								var optionsPaceChart_{{ item_data.workout_obj.workout_id }} = {
									chart: { 
										id: "paceChartInstance-{{ item_data.workout_obj.workout_id }}",
										type: 'line',
										height: 250, 
										zoom: { enabled: true }, 
										toolbar: { show: true, tools: { download: true, selection: true, zoom: true, zoomin: true, zoomout: true, pan: true, reset: true } }
									},
									series: [{
										name: 'Pace (s/500m)',
										data: chartPaceData_{{ item_data.workout_obj.workout_id }} // Use the JS variable
									}],
									xaxis: {
										categories: chartCategories_{{ item_data.workout_obj.workout_id }}, // Use the JS variable
										min: 0,
										title: { text: 'Time (M:SS)' },
										type: 'numeric', 
										labels: { formatter: formatXAxisTime }
									},
									yaxis: {
										title: { text: 'Pace (s/500m)' },
										reversed: true, 
										labels: { formatter: function(val) { const f = formatPaceDisplay(val); return f !== null ? f : '';} }
									},
									tooltip: { 
										y: { formatter: function(val) { const f = formatPaceDisplay(val); return f !== null ? f + " /500m" : null; } }
									},
									stroke: { curve: 'straight', width: 2 },
									dataLabels: { enabled: false },
									markers: { size: 0 }
								};
								var chartPace_{{ item_data.workout_obj.workout_id }} = new ApexCharts(document.querySelector("#paceChart-{{ item_data.workout_obj.workout_id }}"), optionsPaceChart_{{ item_data.workout_obj.workout_id }});
								chartPace_{{ item_data.workout_obj.workout_id }}.render();
							}
						} catch (e) {
							console.error("Error rendering chart for workout ID {{ item_data.workout_obj.workout_id }}:", e);
							var errorDiv = document.querySelector("#paceChart-{{ item_data.workout_obj.workout_id }}");
							if(errorDiv) {
								errorDiv.innerHTML = '<span style="color:red; font-size:0.9em;">Error loading chart data.</span>';
							}
						}
					{% endif %} {# End of Jinja if for data availability #}
				{% endfor %}
			});
		</script>
	</body>
</html>